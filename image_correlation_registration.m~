function image_correlation_registration

%% Get best correlated image and register the data with it

close all
warning off

% If flag = 1, just find top and bottom best match and assign other stacks
% according to z-distance. Flag = 0, find best match for each stack

% Define some variables
flag = 1;
z_data_dist = 9;
z_rep_dist = 1.88;
num_stk_data = 5;
num_stk_rep_data = 31;


x_lim_rep1 = 445;
x_lim_rep2 = 850;

x_lim_data1 = 620;
y_lim_data2 = 'end';


% Declare some Folders
Data_Folder =  '~/Desktop/Image_Register/Data/Fish056_Before/';
Data_Corr_Folder =  '~/Desktop/Image_Register/Data/Fish056_Before/Corr_Images/';
Rep_Image_Folder =  '~/Desktop/Image_Register/Data/1011_GCamp3_KR11_KissPeptinreceptor_F2/';


% Find best match using the corr offset
for ii = 1:num_stk_data
    if flag == 1 && sum(ii == [1,num_stk_data])==0
        continue
    else
        load([Data_Corr_Folder, 'Stack_', int2str(ii)]);
        X(:,ii) = squeeze(corr_off_stk(2,:));
        Y(:,ii) = squeeze(corr_off_stk(1,:));
    end
end

if flag == 1
    [~, Z_best(1)] = min(abs(Y(:,1))+abs(X(:,1)));
    [~, Z_best(num_stk_data)] = min(abs(Y(:,num_stk_data)));
    for ii = 2:num_stk_data-1
        Z_best(ii) = Z_best(ii-1) - fix(Z_best(ii)+(z_data_dist/z_rep_dist));
    end
end

%Save the bext Zs
save([Data_Corr_Folder, 'Z_best.mat'], 'Z_best')

%Register data to the best representative
for ii = 1:num_stk_data
    
    base_img_temp = imread([Rep_Image_Folder,'1011_GCamp3_KR11_KissPeptinreceptor_F2_z', sprintf('%02.0f',Z_best(ii)), '_c01.tif']);
    base_img = eval(['Gcamp(:,', int2str(x_lim_rep1), ':', int2str(x_lim_rep2),')']);
    clear base_
    unreg_img = imread([Data_Folder, 'Raw_Z=', int2str(ii),'_Max.jpg']);
    registered_image = image_register(base_img, unreg_img, X(Z_best(ii),ii), Y(Z_best(ii),ii));
    
    % Plot and save registered images
    fs1 = figure(1);
    set(fs1, 'visible','off')
    subplot(1,3,1)
    imshow(base_img)
    subplot(1,2,2)
    imshow(temp_Stack_Image)
    title(['Offset y ', int2str(corr_offset(1,jj,ii)), ' Offset x ', int2str(corr_offset(2,jj,ii))]);
    name_file = ['Image Correlation : Stack_Image ', int2str(ii), ' Gcamp_Image ', int2str(jj)];
    saveas(fs1, [Result_Folder, filesep, name_file], 'jpg');
end

end

%% Register the image to the best match representative image
function registered_image = image_register(base_img, unreg_img, x_off, y_off)

end


